<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Asteroids</title>
</head>

<body>
    <canvas id="canvas" width="900" height="700"
        style="border:solid 1px orange; padding:0%; margin:auto;display:block;width:800px;height:600px;position:absolute;top:0%;bottom:0%;left:0%;right:0%">
        Your browser does not support HTML5 Canvas.
    </canvas>

    <script>
        //Canvas
        const canvas = document.querySelector('#canvas');
        const ctx = canvas.getContext("2d");

        const w = canvas.width;
        const h = canvas.height;
        const pi = Math.PI;
        const ship_size = 30;
        const FPS = 30;
        let rightKey = false;
        let leftKey = false;
        let spacebar = false;
        let teclaG = false;
        let count = 0;

        //ship definitions
        class Ship {
            constructor(x, y, a) {
                this.x = w / 2,
                    this.y = h / 2,
                    this.r = ship_size / 2,
                    this.a = 0 // convert to radians 
            }

            draw() {
                ctx.strokeStyle = "white";
                ctx.lineWidth = ship_size / 20;
                ctx.beginPath()
                // draw ship
                ctx.strokeStyle = "white";
                ctx.lineWidth = ship_size / 20;
                ctx.beginPath()

                ctx.moveTo(
                    this.x + this.r * Math.cos(0 + this.a),
                    this.y - this.r * Math.sin(0 + this.a)
                );

                ctx.lineTo(
                    this.x + this.r * Math.cos(3 * Math.PI / 4 + this.a),
                    this.y - this.r * Math.sin(3 * Math.PI / 4 + this.a)
                );

                ctx.lineTo(
                    this.x + this.r * Math.cos(-3 * Math.PI / 4 + this.a),
                    this.y - this.r * Math.sin(-3 * Math.PI / 4 + this.a)
                );

                ctx.closePath()
                ctx.stroke();
            }
            update() {
                if (rightKey) {
                    this.a -= 0.15;
                }
                if (leftKey) {
                    this.a += 0.15;
                }
            }

        }

        class Bullet {
            constructor(x, y, c, d) {
                this.x = x;
                this.y = y;
                this.vX = 2 * Math.cos(d);
                this.vY = 2 * Math.sin(d);
                //d = direção -> bico da nave 
                this.d = d;
                this.c = c;
                this.dispawn = false;
            }

            draw() {
                ctx.beginPath();
                ctx.fillStyle = this.c;
                ctx.arc(this.x, this.y, 3, 0, 2 * pi);
                ctx.fill();
            }

            update() {
                if (this.x - 3 < 0 || this.x + 3 > w)
                    this.dispawn = true
                if (this.y - 3 < 0 || this.y + 3 > h)
                    this.dispawn = true

                this.x += this.vX; //update horizontal position 
                this.y += this.vY; //update vertical position 
            }

        }

        class Asteroid {
            constructor(x, y, c, d) {
                this.x = x;
                this.y = y;
                this.vX = 2 * Math.cos(d);
                this.vY = 2 * Math.sin(d);
                this.c = c;
                this.dispawn = false;
            }

            draw() {
                ctx.fillStyle = this.c;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 10, 0, 2 * Math.PI);
                ctx.fill();
            }
            update() {
                //check Canvas vertical collisions
                if (this.x - 20 < 0 || this.x + 20 > w)
                    this.dispawn = true
                //check Canvas horizontal collisions
                if (this.y - 20 < 0 || this.y + 20 > h)
                    this.dispawn = true

                this.x += this.vX; //update horizontal position 
                this.y += this.vY; //update vertical position 
            }
        }

        let bullets = new Array();
        let asteroids = new Array();
        let ship = new Ship();

        //ANIMATION CYCLE
        function render() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, w, h);
            count++



            ship.draw();
            ship.update();

            //draw & update            
            bullets.forEach(function (bullet) {
                bullet.draw();
                bullet.update();
            });
            // spawn asteroids
            if (count % 60 == 0) {
                let x = 0;
                let y = 0;
                let color = 'white';
                let direction = Math.random() * 2 * pi
                console.log("novo asteroid")

                asteroids.push(new Asteroid(x, y, color, direction))
            }
            //draw & update
            asteroids.forEach(function (asteroid) {
                asteroid.draw();
                asteroid.update();
            });

            for (let i = bullets.length - 1; i >= 0; i--) {
                // check if partical has left the canvas                
                if (bullets[i].dispawn == true) {
                    bullets.splice(i, 1)
                }
            }
            for (let i = asteroids.length - 1; i >= 0; i--) {
                // check if partical has left the canvas
                if (asteroids[i].dispawn == true) {
                    asteroids.splice(i, 1)
                }
            }


            //new frame
            window.requestAnimationFrame(render);
        }



        render();


        //handler para espaço = balas 
        //32 = barra de espaços
        function spaceBarPressed(e) {
            if (e.keyCode == 32) {
                spacebar = true;
            }
            if (spacebar) {
                let x = w / 2;
                let y = h / 2;
                let color = 'white';
                let direction = 4 * 2 * Math.PI;

                bullets.push(new Bullet(x, y, color, direction))

            }
        }



        //handler for keydown
        function KeyPressed(e) {
            //SETAS
            if (e.key == 'ArrowRight') {
                rightKey = true;

            }
            if (e.key == 'ArrowLeft') {
                leftKey = true;
            }
            //tecla G
            if (e.keyCode == 71) {
                teclaG = true;
            }
            //SPACEBAR
            if (e.keyCode == 32 && !e.repeat) {
                let x = w / 2;
                let y = h / 2;
                let color = 'white';
                let direction = 4 * 2 * Math.PI;

                bullets.push(new Bullet(x, y, color, direction))
            }


        }
        //handler for keyup
        function ArrowReleased(e) {
            if (e.key == 'ArrowRight')
                rightKey = false;

            if (e.key == 'ArrowLeft') {
                leftKey = false;
            }
        }



        function asteroidSpawnStop(e) {
            if (e.keyCode == 71) {
                teclaG = false;
                console.log("saiu o G bro")

            }
        }


        window.addEventListener('keydown', KeyPressed);
        window.addEventListener('keyup', asteroidSpawnStop);
        window.addEventListener('keyup', ArrowReleased);
    </script>
</body>

</html>